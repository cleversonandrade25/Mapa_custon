<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>City Roads - Pro Export Edition</title>
    <style>
        body { margin: 0; background: #f0f0f0; color: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; }
        #sidebar { 
            width: 340px; height: 100vh; background: #fff; border-right: 2px solid #000; 
            padding: 20px; box-sizing: border-box; z-index: 10; display: flex; flex-direction: column; gap: 12px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.1); overflow-y: auto;
        }
        .group { display: flex; flex-direction: column; gap: 4px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        label { font-size: 10px; font-weight: bold; text-transform: uppercase; color: #666; }
        input, select { padding: 8px; border: 1px solid #000; outline: none; font-size: 13px; }
        .row { display: flex; gap: 5px; align-items: center; }
        button { background: #000; color: #fff; border: none; padding: 12px; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.2s; }
        button:hover { background: #333; }
        button:disabled { background: #ccc; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-secondary { background: #fff; color: #000; border: 2px solid #000; }
        .btn-secondary:hover { background: #f0f0f0; }
        .btn-outline { background: transparent; color: #000; border: 1px solid #000; padding: 8px; font-size: 11px; }
        
        #main { flex-grow: 1; position: relative; background: #fff; display: flex; align-items: center; justify-content: center; }
        canvas { display: block; max-width: 100%; max-height: 100%; border: 1px solid #ddd; cursor: grab; }
        canvas:active { cursor: grabbing; }
        #status { position: absolute; bottom: 15px; right: 15px; font-size: 10px; background: #000; color: #fff; padding: 4px 8px; z-index: 20; }
        #controls { position: absolute; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 20; }
        .ctrl-btn { background: #fff; border: 1px solid #000; padding: 6px 10px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .ctrl-btn:hover { background: #f0f0f0; }
        h2 { margin: 0; font-size: 18px; letter-spacing: 1px; }
        .info-text { font-size: 10px; color: #666; font-style: italic; }
        .preview-box { border: 1px solid #ddd; padding: 8px; background: #f9f9f9; font-size: 10px; max-height: 80px; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>CITY ROADS PRO</h2>
        
        <div class="group">
            <label>Localiza√ß√£o</label>
            <input type="text" id="busca" placeholder="CEP ou Nome da Rua">
            <input type="number" id="raio" value="1200" title="Raio em metros">
            <div class="row">
                <button class="btn-outline" onclick="usarLocalizacaoAtual()">üìç Usar Minha Localiza√ß√£o</button>
            </div>
        </div>

        <button id="btnGerar" onclick="iniciar()">Gerar Mapa</button>

        <div class="group">
            <label>Zoom e Precis√£o</label>
            <div class="row">
                <input type="range" id="zoomLevel" min="0.5" max="3" step="0.1" value="1" oninput="atualizarZoom()" title="Zoom">
                <span style="font-size:11px">Zoom: <span id="zoomValue">1.0x</span></span>
            </div>
            <div class="row">
                <input type="range" id="densidade" min="0.5" max="2" step="0.1" value="1" oninput="desenhar()" title="Densidade de pontos">
                <span style="font-size:11px">Qualidade</span>
            </div>
        </div>

        <div class="group">
            <label>Cores das Vias</label>
            <div class="row">
                <input type="color" id="colorMain" value="#000000" oninput="desenhar()">
                <span style="font-size:11px">Avenidas</span>
            </div>
            <div class="row">
                <input type="color" id="colorMinor" value="#888888" oninput="desenhar()">
                <span style="font-size:11px">Residenciais</span>
            </div>
            <div class="row">
                <input type="checkbox" id="showLabels" onchange="desenhar()">
                <span style="font-size:11px">Mostrar Nomes (SVG)</span>
            </div>
        </div>

        <div class="group">
            <label>Marcador Central</label>
            <div class="row">
                <input type="checkbox" id="showCenter" onchange="desenhar()" checked>
                <input type="color" id="centerColor" value="#ff0000" oninput="desenhar()">
                <input type="range" id="centerSize" min="2" max="15" value="5" oninput="desenhar()">
            </div>
        </div>

        <div class="group">
            <label>An√©is de Caminhada (Is√≥cronas)</label>
            <div class="row">
                <input type="checkbox" id="showTimeRings" onchange="desenhar()">
                <span style="font-size:11px">5, 10, 15 min</span>
            </div>
            <input type="color" id="ringColor" value="#cccccc" oninput="desenhar()">
            <div class="row">
                <input type="number" id="walkSpeed" value="80" min="40" max="120" style="width: 60px;" title="Velocidade m√©dia (m/min)">
                <span style="font-size:11px">m/min</span>
            </div>
        </div>

        <div class="group">
            <label>Estilo do Fundo e Tra√ßo</label>
            <div class="row">
                <input type="color" id="bgColor" value="#ffffff" oninput="desenhar()">
                <span style="font-size:11px">Cor de Fundo</span>
            </div>
            <input type="range" id="lineWidth" min="0.1" max="4" step="0.1" value="1" oninput="desenhar()">
            <div class="row">
                <input type="checkbox" id="showGrid" onchange="desenhar()">
                <span style="font-size:11px">Grade de Refer√™ncia</span>
            </div>
        </div>

        <div class="group">
            <label>Exporta√ß√£o</label>
            <div class="btn-group">
                <button onclick="baixarImagem()" style="padding: 8px;">PNG</button>
                <button onclick="baixarSVG()" style="padding: 8px;">SVG</button>
            </div>
            <div class="btn-group" style="margin-top: 4px;">
                <button class="btn-secondary" onclick="baixarJPG()" style="padding: 8px;">JPG</button>
                <button class="btn-secondary" onclick="baixarJSON()" style="padding: 8px;">JSON</button>
            </div>
            <div class="row" style="margin-top: 4px;">
                <input type="number" id="exportWidth" value="2000" min="500" max="8000" style="width: 70px;" title="Largura de exporta√ß√£o">
                <span style="font-size:11px">px largura</span>
            </div>
        </div>

        <div class="group">
            <label>Informa√ß√µes do Mapa</label>
            <div id="infoMap" class="preview-box">Aguardando gera√ß√£o...</div>
        </div>

        <div class="group">
            <label>atalhos</label>
            <div class="info-text">
                Scroll: Zoom | Arrastar: Mover | Clique: Centralizar
            </div>
        </div>
    </div>

    <div id="main">
        <div id="controls">
            <button class="ctrl-btn" onclick="resetZoom()">Reset Zoom</button>
            <button class="ctrl-btn" onclick="toggleFullscreen()">‚õ∂</button>
            <button class="ctrl-btn" onclick="limparMapa()">üóëÔ∏è</button>
        </div>
        <canvas id="mapCanvas"></canvas>
        <div id="status">SISTEMA PRONTO</div>
    </div>

    <script>
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const btnGerar = document.getElementById('btnGerar');
        const infoMap = document.getElementById('infoMap');

        let lastData = null, lastCoords = null, lastRaio = null;
        let zoom = 1.0;
        let offsetX = 0, offsetY = 0;
        let isDragging = false;
        let dragStart = {x: 0, y: 0};
        let lastMousePos = {x: 0, y: 0};

        // Fun√ß√µes de Utilidade
        function formatarDistancia(metros) {
            if (metros < 1000) return `${Math.round(metros)}m`;
            return `${(metros/1000).toFixed(2)}km`;
        }

        function atualizarInfo() {
            if (!lastData || !lastCoords) return;
            const count = lastData.length;
            const raio = lastRaio;
            const area = (Math.PI * raio * raio / 1000000).toFixed(2);
            infoMap.innerHTML = `
                <strong>Vias:</strong> ${count}<br>
                <strong>Raio:</strong> ${formatarDistancia(raio)}<br>
                <strong>√Årea:</strong> ${area} km¬≤<br>
                <strong>Centro:</strong> ${lastCoords.lat.toFixed(4)}, ${lastCoords.lon.toFixed(4)}<br>
                <strong>Zoom:</strong> ${zoom.toFixed(2)}x
            `;
        }

        // Fun√ß√µes de Zoom e Pan
        function atualizarZoom() {
            const slider = document.getElementById('zoomLevel');
            zoom = parseFloat(slider.value);
            document.getElementById('zoomValue').textContent = zoom.toFixed(1) + 'x';
            desenhar();
            atualizarInfo();
        }

        function resetZoom() {
            zoom = 1.0;
            offsetX = 0;
            offsetY = 0;
            document.getElementById('zoomLevel').value = 1;
            document.getElementById('zoomValue').textContent = '1.0x';
            desenhar();
        }

        // Eventos de Mouse para Zoom/Pan
        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            dragStart = {x: e.clientX, y: e.clientY};
            lastMousePos = {x: e.clientX, y: e.clientY};
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const dx = e.clientX - lastMousePos.x;
                const dy = e.clientY - lastMousePos.y;
                offsetX += dx;
                offsetY += dy;
                lastMousePos = {x: e.clientX, y: e.clientY};
                desenhar();
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
        });

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            const newZoom = Math.max(0.5, Math.min(3, zoom + delta));
            if (newZoom !== zoom) {
                zoom = newZoom;
                document.getElementById('zoomLevel').value = zoom;
                document.getElementById('zoomValue').textContent = zoom.toFixed(1) + 'x';
                desenhar();
                atualizarInfo();
            }
        });

        // Localiza√ß√£o Atual
        function usarLocalizacaoAtual() {
            if (!navigator.geolocation) {
                alert('Geolocaliza√ß√£o n√£o suportada pelo navegador.');
                return;
            }
            
            status.innerText = "OBTENDO LOCALIZA√á√ÉO...";
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;
                    document.getElementById('busca').value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                    status.innerText = "LOCALIZA√á√ÉO OBTIDA";
                },
                (err) => {
                    alert('Erro ao obter localiza√ß√£o: ' + err.message);
                    status.innerText = "ERRO";
                }
            );
        }

        // Fun√ß√µes de Redimensionamento e Desenho
        function resize() {
            const main = document.getElementById('main');
            canvas.width = main.clientWidth;
            canvas.height = main.clientHeight;
            if (lastData) desenhar();
        }
        window.addEventListener('resize', resize);
        resize();

        async function iniciar() {
            const busca = document.getElementById('busca').value.trim();
            const raio = parseInt(document.getElementById('raio').value);
            if (!busca) return alert("Por favor, digite um local.");

            btnGerar.disabled = true;
            status.innerText = "LOCALIZANDO...";

            try {
                let q = busca;
                // Verifica se √© CEP
                if (/^[0-9]{8}$/.test(busca.replace(/\D/g, ''))) {
                    const res = await fetch(`https://viacep.com.br/ws/${busca.replace(/\D/g, '')}/json/`);
                    const d = await res.json();
                    q = d.erro ? busca : `${d.logradouro}, ${d.localidade}, Brazil`;
                }
                // Verifica se √© coordenadas
                else if (busca.includes(',') && !isNaN(parseFloat(busca.split(',')[0]))) {
                    q = busca;
                }

                const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
                const geoData = await geoRes.json();
                if (!geoData.length) throw "Local n√£o encontrado no banco de dados.";

                const lat = parseFloat(geoData[0].lat);
                const lon = parseFloat(geoData[0].lon);

                status.innerText = "BAIXANDO VIAS...";
                const d = raio / 111320;
                const bbox = `${lat - d},${lon - d*1.4},${lat + d},${lon + d*1.4}`;
                const query = `[out:json][timeout:60];way["highway"](${bbox});out geom;`;

                const response = await fetch(`https://overpass.kumi.systems/api/interpreter`, {
                    method: 'POST', body: `data=${encodeURIComponent(query)}`
                });
                const ovData = await response.json();

                lastData = ovData.elements;
                lastCoords = {lat, lon};
                lastRaio = raio;

                // Reset visual
                offsetX = 0;
                offsetY = 0;
                
                desenhar();
                atualizarInfo();
                status.innerText = "PRONTO";
            } catch (e) {
                alert(e);
                status.innerText = "ERRO";
            } finally {
                btnGerar.disabled = false;
            }
        }

        function desenhar() {
            if (!lastData) return;
            
            const bg = document.getElementById('bgColor').value;
            const cMain = document.getElementById('colorMain').value;
            const cMinor = document.getElementById('colorMinor').value;
            const width = parseFloat(document.getElementById('lineWidth').value);
            const densidade = parseFloat(document.getElementById('densidade').value);
            
            // C√°lculo de escala com zoom
            const baseScale = (canvas.height / (lastRaio * 2)) * 111320;
            const scale = baseScale * zoom;

            // Limpar canvas
            ctx.fillStyle = bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Grade de refer√™ncia
            if (document.getElementById('showGrid').checked) {
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 0.5;
                const gridSize = 50;
                for (let x = 0; x < canvas.width; x += gridSize) {
                    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
                }
                for (let y = 0; y < canvas.height; y += gridSize) {
                    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
                }
            }

            // 1. An√©is de Tempo (Export√°veis no PNG)
            if (document.getElementById('showTimeRings').checked) {
                const walkSpeed = parseInt(document.getElementById('walkSpeed').value) || 80;
                ctx.strokeStyle = document.getElementById('ringColor').value;
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 8]);
                [5, 10, 15].forEach(min => {
                    const rPixels = (min * walkSpeed) * (scale / 111320); 
                    ctx.beginPath();
                    ctx.arc(canvas.width/2 + offsetX, canvas.height/2 + offsetY, rPixels, 0, Math.PI*2);
                    ctx.stroke();
                    
                    // Label do anel
                    ctx.fillStyle = document.getElementById('ringColor').value;
                    ctx.font = '9px sans-serif';
                    ctx.fillText(`${min}min`, canvas.width/2 + offsetX + rPixels + 5, canvas.height/2 + offsetY - 2);
                });
                ctx.setLineDash([]);
            }

            // 2. Ruas
            const mainTypes = ["motorway", "trunk", "primary", "secondary", "tertiary"];
            lastData.forEach(way => {
                if (!way.geometry) return;
                
                // Aplicar densidade (pular pontos se necess√°rio)
                const pontos = way.geometry.filter((_, i) => i % Math.ceil(1/densidade) === 0);
                if (pontos.length < 2) return;

                const isMain = mainTypes.includes(way.tags.highway);
                ctx.beginPath();
                ctx.strokeStyle = isMain ? cMain : cMinor;
                ctx.lineWidth = (isMain ? width * 1.8 : width) * zoom;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                pontos.forEach((p, i) => {
                    const x = canvas.width/2 + offsetX + (p.lon - lastCoords.lon) * scale * Math.cos(lastCoords.lat * Math.PI/180);
                    const y = canvas.height/2 + offsetY - (p.lat - lastCoords.lat) * scale;
                    if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                });
                ctx.stroke();
            });

            // 3. Marcador Central
            if (document.getElementById('showCenter').checked) {
                ctx.fillStyle = document.getElementById('centerColor').value;
                const cSize = parseFloat(document.getElementById('centerSize').value) * zoom;
                ctx.beginPath();
                ctx.arc(canvas.width/2 + offsetX, canvas.height/2 + offsetY, cSize, 0, Math.PI*2);
                ctx.fill();
                
                // Cruz no centro
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(canvas.width/2 + offsetX - cSize, canvas.height/2 + offsetY);
                ctx.lineTo(canvas.width/2 + offsetX + cSize, canvas.height/2 + offsetY);
                ctx.moveTo(canvas.width/2 + offsetX, canvas.height/2 + offsetY - cSize);
                ctx.lineTo(canvas.width/2 + offsetX, canvas.height/2 + offsetY + cSize);
                ctx.stroke();
            }
        }

        // Fun√ß√µes de Exporta√ß√£o
        function baixarImagem() {
            if (!lastData) return;
            const a = document.createElement('a');
            const nome = document.getElementById('busca').value.replace(/[^a-zA-Z0-9]/g, '_');
            a.download = `mapa_${nome || 'cidade'}.png`;
            a.href = canvas.toDataURL("image/png");
            a.click();
        }

        function baixarJPG() {
            if (!lastData) return;
            
            // Criar canvas tempor√°rio com fundo branco para JPG
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            
            // Preencher fundo branco
            tempCtx.fillStyle = '#ffffff';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            // Copiar do canvas principal
            tempCtx.drawImage(canvas, 0, 0);
            
            const a = document.createElement('a');
            const nome = document.getElementById('busca').value.replace(/[^a-zA-Z0-9]/g, '_');
            a.download = `mapa_${nome || 'cidade'}.jpg`;
            a.href = tempCanvas.toDataURL("image/jpeg", 0.95);
            a.click();
        }

        function baixarSVG() {
            if (!lastData) return;
            
            const scale = (canvas.height / (lastRaio * 2)) * 111320 * zoom;
            const bg = document.getElementById('bgColor').value;
            const cMain = document.getElementById('colorMain').value;
            const cMinor = document.getElementById('colorMinor').value;
            const width = document.getElementById('lineWidth').value;
            const densidade = parseFloat(document.getElementById('densidade').value);
            const mainTypes = ["motorway", "trunk", "primary", "secondary", "tertiary"];
            const showLabels = document.getElementById('showLabels').checked;

            let s = `<svg xmlns="http://www.w3.org/2000/svg" width="${canvas.width}" height="${canvas.height}" viewBox="0 0 ${canvas.width} ${canvas.height}">`;
            
            // Fundo
            s += `<rect width="100%" height="100%" fill="${bg}"/>`;
            
            // Grade
            if (document.getElementById('showGrid').checked) {
                s += `<defs><pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse"><path d="M 50 0 L 0 0 0 50" fill="none" stroke="#e0e0e0" stroke-width="0.5"/></pattern></defs>`;
                s += `<rect width="100%" height="100%" fill="url(#grid)"/>`;
            }

            // An√©is no SVG
            if (document.getElementById('showTimeRings').checked) {
                const ringCol = document.getElementById('ringColor').value;
                const walkSpeed = parseInt(document.getElementById('walkSpeed').value) || 80;
                [5, 10, 15].forEach(min => {
                    const r = (min * walkSpeed) * (scale / 111320);
                    s += `<circle cx="${canvas.width/2 + offsetX}" cy="${canvas.height/2 + offsetY}" r="${r}" fill="none" stroke="${ringCol}" stroke-width="1" stroke-dasharray="5,8" />`;
                    s += `<text x="${canvas.width/2 + offsetX + r + 5}" y="${canvas.height/2 + offsetY - 2}" font-size="9" fill="${ringCol}">${min}min</text>`;
                });
            }

            // Vias no SVG
            lastData.forEach((way, idx) => {
                if (!way.geometry) return;
                const pontos = way.geometry.filter((_, i) => i % Math.ceil(1/densidade) === 0);
                if (pontos.length < 2) return;
                
                const isMain = mainTypes.includes(way.tags.highway);
                let d = "";
                pontos.forEach((p, i) => {
                    const x = canvas.width/2 + offsetX + (p.lon - lastCoords.lon) * scale * Math.cos(lastCoords.lat * Math.PI/180);
                    const y = canvas.height/2 + offsetY - (p.lat - lastCoords.lat) * scale;
                    d += (i === 0 ? "M" : "L") + `${x.toFixed(2)},${y.toFixed(2)} `;
                });
                
                s += `<path d="${d}" fill="none" stroke="${isMain ? cMain : cMinor}" stroke-width="${(isMain ? width*1.8 : width) * zoom}" stroke-linecap="round" stroke-linejoin="round"/>`;
                
                // Adicionar labels se habilitado
                if (showLabels && way.tags.name) {
                    const midPoint = pontos[Math.floor(pontos.length / 2)];
                    const x = canvas.width/2 + offsetX + (midPoint.lon - lastCoords.lon) * scale * Math.cos(lastCoords.lat * Math.PI/180);
                    const y = canvas.height/2 + offsetY - (midPoint.lat - lastCoords.lat) * scale;
                    s += `<text x="${x}" y="${y}" font-size="8" fill="${isMain ? cMain : cMinor}" opacity="0.7">${way.tags.name.replace(/</g, '<')}</text>`;
                }
            });

            // Centro no SVG
            if (document.getElementById('showCenter').checked) {
                const cSize = parseFloat(document.getElementById('centerSize').value) * zoom;
                s += `<circle cx="${canvas.width/2 + offsetX}" cy="${canvas.height/2 + offsetY}" r="${cSize}" fill="${document.getElementById('centerColor').value}" />`;
                s += `<line x1="${canvas.width/2 + offsetX - cSize}" y1="${canvas.height/2 + offsetY}" x2="${canvas.width/2 + offsetX + cSize}" y2="${canvas.height/2 + offsetY}" stroke="#fff" stroke-width="1" />`;
                s += `<line x1="${canvas.width/2 + offsetX}" y1="${canvas.height/2 + offsetY - cSize}" x2="${canvas.width/2 + offsetX}" y2="${canvas.height/2 + offsetY + cSize}" stroke="#fff" stroke-width="1" />`;
            }

            s += `</svg>`;
            
            const b = new Blob([s], {type: 'image/svg+xml'});
            const a = document.createElement('a');
            const nome = document.getElementById('busca').value.replace(/[^a-zA-Z0-9]/g, '_');
            a.href = URL.createObjectURL(b); 
            a.download = `mapa_${nome || 'cidade'}.svg`; 
            a.click();
        }

        function baixarJSON() {
            if (!lastData) return;
            
            const exportData = {
                metadata: {
                    localizacao: document.getElementById('busca').value,
                    centro: lastCoords,
                    raio: lastRaio,
                    timestamp: new Date().toISOString(),
                    versao: 'City Roads Pro 2.0'
                },
                configuracoes: {
                    zoom: zoom,
                    cores: {
                        avenidas: document.getElementById('colorMain').value,
                        residenciais: document.getElementById('colorMinor').value,
                        fundo: document.getElementById('bgColor').value,
                        centro: document.getElementById('centerColor').value
                    },
                    aneis: {
                        ativo: document.getElementById('showTimeRings').checked,
                        velocidade: document.getElementById('walkSpeed').value
                    }
                },
                vias: lastData.map(way => ({
                    tipo: way.tags.highway,
                    nome: way.tags.name || null,
                    geometria: way.geometry
                }))
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            const nome = document.getElementById('busca').value.replace(/[^a-zA-Z0-9]/g, '_');
            a.href = URL.createObjectURL(blob);
            a.download = `mapa_${nome || 'cidade'}.json`;
            a.click();
        }

        // Outras Fun√ß√µes
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        function limparMapa() {
            if (confirm('Deseja realmente limpar o mapa atual?')) {
                lastData = null;
                lastCoords = null;
                lastRaio = null;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                infoMap.innerHTML = 'Aguardando gera√ß√£o...';
                status.innerText = "SISTEMA PRONTO";
            }
        }

        // Atalhos de teclado
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                resetZoom();
            }
            if (e.key === 'd' && e.ctrlKey) {
                e.preventDefault();
                baixarImagem();
            }
            if (e.key === 'Escape' && isDragging) {
                isDragging = false;
            }
        });
    </script>
</body>
</html>