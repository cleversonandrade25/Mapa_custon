<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Clever Map - Master Pro Edition</title>
    <style>
        :root { --primary: #000; --bg-ui: #fff; --border: #000; }
        body { margin: 0; background: #95a5a6; color: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; }
        
        #sidebar { 
            width: 380px; height: 100vh; background: var(--bg-ui); border-right: 2px solid var(--border); 
            padding: 15px; box-sizing: border-box; z-index: 10; display: flex; flex-direction: column; gap: 8px;
            box-shadow: 5px 0 25px rgba(0,0,0,0.3); overflow-y: auto;
        }
        h2 { margin: 0; font-size: 18px; letter-spacing: 1px; border-bottom: 3px solid var(--border); padding-bottom: 5px; text-align: center; }
        .group { display: flex; flex-direction: column; gap: 4px; border-bottom: 1px solid #ddd; padding-bottom: 8px; }
        label { font-size: 9px; font-weight: bold; text-transform: uppercase; color: #444; }
        input, select { padding: 6px; border: 1px solid var(--border); outline: none; font-size: 12px; }
        .row { display: flex; gap: 6px; align-items: center; justify-content: space-between; }
        button { background: var(--primary); color: #fff; border: none; padding: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 10px; }
        button:hover { background: #333; }
        .btn-outline { background: transparent; color: #000; border: 1px solid var(--border); padding: 4px; font-size: 10px; cursor: pointer; }
        .info-panel { border: 1px solid #ccc; padding: 6px; background: #fdfdfd; font-size: 10px; font-family: monospace; }
        
        #main { flex-grow: 1; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        canvas { background: #fff; cursor: grab; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>CLEVER MAP MASTER</h2>
        
        <div class="group">
            <label>üìç Localiza√ß√£o</label>
            <input type="text" id="busca" placeholder="Endere√ßo...">
            <div class="row">
                <input type="text" id="latInput" placeholder="Lat" style="width: 48%;">
                <input type="text" id="lonInput" placeholder="Lon" style="width: 48%;">
            </div>
            <div class="row">
                <span>Raio (m):</span>
                <input type="number" id="raio" value="1200" style="width: 70px;">
                <button onclick="iniciar()" style="flex:1">GERAR MAPA</button>
            </div>
        </div>

        <div class="group">
            <label>üé® Estilo Visual</label>
            <div class="row">
                <button class="btn-outline" onclick="setPreset('dark')">Dark</button>
                <button class="btn-outline" onclick="setPreset('blueprint')">Blueprint</button>
                <button class="btn-outline" onclick="setPreset('minimal')">Minimal</button>
                <button class="btn-outline" onclick="setPreset('gray')">Gray</button>
            </div>
            <div class="row">
                <span>Fundo:</span> <input type="color" id="bgColor" value="#ffffff" oninput="desenhar()">
                <span>Grade:</span> <input type="color" id="gridColor" value="#cccccc" oninput="desenhar()">
            </div>
        </div>

        <div class="group">
            <label>üõ£Ô∏è Vias (Principais / Secund.)</label>
            <div class="row">
                <input type="color" id="colorMain" value="#000000" oninput="desenhar()">
                <input type="range" id="widthMain" min="0.5" max="15" step="0.5" value="3" oninput="desenhar()" style="width:70%">
            </div>
            <div class="row">
                <input type="color" id="colorMinor" value="#999999" oninput="desenhar()">
                <input type="range" id="widthMinor" min="0.1" max="8" step="0.1" value="1" oninput="desenhar()" style="width:70%">
            </div>
        </div>

        <div class="group">
            <label>üîç Zoom e Grade</label>
            <div class="row">
                <span>Zoom:</span> <input type="range" id="zoomLevel" min="0.1" max="8" step="0.1" value="1" oninput="atualizarZoom()">
            </div>
            <div class="row">
                <input type="checkbox" id="showGrid" onchange="desenhar()" checked> Grade Ativa
            </div>
        </div>

        <div class="group">
            <label>üè† Marcador Central</label>
            <div class="row">
                <input type="checkbox" id="showCenter" onchange="desenhar()" checked> <b>Habilitar</b>
                <input type="color" id="centerColor" value="#ff0000" oninput="desenhar()">
            </div>
            <div class="row">
                <label>√çcone:</label>
                <select id="centerIcon" onchange="desenhar()" style="flex:1">
                    <optgroup label="Mapas">
                        <option value="üìç">üìç Pin Padr√£o</option>
                        <option value="üìå">üìå Tachinha</option>
                        <option value="üö©">üö© Bandeira</option>
                        <option value="üéØ">üéØ Alvo</option>
                        <option value="‚≠ï">‚≠ï C√≠rculo</option>
                    </optgroup>
                    <optgroup label="Im√≥veis/Arquitetura">
                        <option value="üè†">üè† Casa</option>
                        <option value="üè¢">üè¢ Pr√©dio</option>
                        <option value="üè®">üè® Hotel</option>
                        <option value="üè≠">üè≠ Ind√∫stria</option>
                        <option value="üèóÔ∏è">üèóÔ∏è Constru√ß√£o</option>
                    </optgroup>
                    <optgroup label="Neg√≥cios">
                        <option value="üõí">üõí Loja</option>
                        <option value="üç¥">üç¥ Restaurante</option>
                        <option value="‚õΩ">‚õΩ Posto</option>
                        <option value="üè¶">üè¶ Banco</option>
                    </optgroup>
                </select>
            </div>
            <input type="text" id="centerLabel" placeholder="Legenda do centro" oninput="desenhar()">
            <div class="row">
                <span>Cor Texto:</span> <input type="color" id="centerTextColor" value="#000000" oninput="desenhar()">
            </div>
        </div>

        <div class="group">
            <label>‚≠ï Is√≥cronas</label>
            <div class="row">
                <input type="checkbox" id="showTimeRings" onchange="desenhar()" checked> Exibir
                <input type="color" id="ringColor" value="#999999" oninput="desenhar()">
            </div>
            <div class="row">
                <span>Estilo:</span>
                <select id="ringStyle" onchange="desenhar()">
                    <option value="dashed">Tracejado</option>
                    <option value="solid">S√≥lido</option>
                </select>
            </div>
            <div class="row">
                <span>An√©is:</span><input type="number" id="ringCount" value="3" style="width:35px" oninput="desenhar()">
                <span>Min:</span><input type="number" id="ringInterval" value="5" style="width:35px" oninput="desenhar()">
            </div>
        </div>

        <div class="group">
            <label>üíæ Exporta√ß√£o HD e Vetor (SVG)</label>
            <div class="row">
                <span>PNG (Px):</span>
                <input type="number" id="exportPx" value="3000" style="width: 70px;">
                <select id="exportFormat" onchange="ajustarProporcao()" style="width: 80px;">
                    <option value="free">Livre</option>
                    <option value="1:1">1:1</option>
                    <option value="a4-p">A4 Port.</option>
                    <option value="a4-l">A4 Land.</option>
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px;">
                <button onclick="baixarImagem('png')">PNG HD</button>
                <button onclick="baixarImagem('jpg')">JPG HD</button>
                <button onclick="baixarSVG()" style="background:#2ecc71">VETOR (SVG)</button>
                <button onclick="baixarJSON()" class="btn-outline">JSON</button>
            </div>
        </div>

        <div id="infoMap" class="info-panel">Aguardando dados...</div>
    </div>

    <div id="main">
        <canvas id="mapCanvas"></canvas>
        <div style="position:absolute; bottom:15px; right:15px; background:black; color:white; padding:5px; font-size:10px;" id="status">PRONTO</div>
    </div>

    <script>
        const canvas = document.getElementById('mapCanvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        const infoMap = document.getElementById('infoMap');

        let lastData = null, lastCoords = null, lastRaio = null;
        let zoom = 1.0, offsetX = 0, offsetY = 0;
        let isDragging = false, lastMousePos = {x: 0, y: 0};
        let marcadoresExtras = [], modoAdicionarMarcador = false;

        const presets = {
            dark: { bg: "#111111", main: "#ffffff", minor: "#444444", grid: "#222222" },
            blueprint: { bg: "#0a254d", main: "#a0c4ff", minor: "#2a4d7d", grid: "#1a3a6d" },
            minimal: { bg: "#ffffff", main: "#000000", minor: "#eeeeee", grid: "#f0f0f0" },
            gray: { bg: "#f0f0f0", main: "#333333", minor: "#999999", grid: "#dddddd" }
        };

        function setPreset(p) {
            const s = presets[p];
            document.getElementById('bgColor').value = s.bg;
            document.getElementById('colorMain').value = s.main;
            document.getElementById('colorMinor').value = s.minor;
            document.getElementById('gridColor').value = s.grid;
            desenhar();
        }

        function atualizarZoom() { zoom = parseFloat(document.getElementById('zoomLevel').value); desenhar(); }

        async function iniciar() {
            const busca = document.getElementById('busca').value;
            const latM = document.getElementById('latInput').value;
            const lonM = document.getElementById('lonInput').value;
            const raio = parseInt(document.getElementById('raio').value);
            status.innerText = "BUSCANDO...";
            try {
                let lat, lon;
                if (latM && lonM) {
                    lat = parseFloat(latM); lon = parseFloat(lonM);
                } else {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(busca)}&limit=1`);
                    const data = await res.json();
                    if (!data.length) throw "Local n√£o encontrado.";
                    lat = parseFloat(data[0].lat); lon = parseFloat(data[0].lon);
                    document.getElementById('latInput').value = lat.toFixed(6);
                    document.getElementById('lonInput').value = lon.toFixed(6);
                }
                const d = raio / 111320;
                const bbox = `${lat - d},${lon - d*1.5},${lat + d},${lon + d*1.5}`;
                const query = `[out:json];way["highway"](${bbox});out geom;`;
                const ovRes = await fetch(`https://overpass.kumi.systems/api/interpreter`, { method: 'POST', body: `data=${encodeURIComponent(query)}` });
                const ovData = await ovRes.json();
                lastData = ovData.elements; lastCoords = {lat, lon}; lastRaio = raio;
                status.innerText = "SUCESSO"; desenhar(); atualizarEstat();
            } catch (e) { alert("Erro: " + e); status.innerText = "ERRO"; }
        }

        function desenhar(tCtx = ctx, tW = canvas.width, tH = canvas.height, isExport = false) {
            if (!lastData) return;
            const baseW = canvas.width, baseH = canvas.height;
            const exportScale = isExport ? (tW / baseW) : 1;

            tCtx.save();
            if (isExport) tCtx.scale(exportScale, exportScale);

            // Coleta de dados com prote√ß√£o contra NULL
            const getVal = (id) => document.getElementById(id)?.value;
            const getCheck = (id) => document.getElementById(id)?.checked;

            const cfg = {
                bg: getVal('bgColor'),
                cMain: getVal('colorMain'),
                cMin: getVal('colorMinor'),
                wMain: parseFloat(getVal('widthMain')) * zoom,
                wMin: parseFloat(getVal('widthMinor')) * zoom,
                gCol: getVal('gridColor'),
                gStep: 100 * zoom,
                rCol: getVal('ringColor'),
                rSty: getVal('ringStyle')
            };

            tCtx.fillStyle = cfg.bg;
            tCtx.fillRect(0, 0, baseW, baseH);

            const scaleFactor = (baseH / (lastRaio * 2)) * 111320 * zoom;

            // 1. Grade
            if (getCheck('showGrid')) {
                tCtx.strokeStyle = cfg.gCol; tCtx.lineWidth = 1;
                for(let i = (baseW/2 + offsetX) % cfg.gStep; i < baseW; i += cfg.gStep) { tCtx.beginPath(); tCtx.moveTo(i, 0); tCtx.lineTo(i, baseH); tCtx.stroke(); }
                for(let i = (baseH/2 + offsetY) % cfg.gStep; i < baseH; i += cfg.gStep) { tCtx.beginPath(); tCtx.moveTo(0, i); tCtx.lineTo(baseW, i); tCtx.stroke(); }
            }

            // 2. Is√≥cronas
            if (getCheck('showTimeRings')) {
                tCtx.strokeStyle = cfg.rCol; tCtx.lineWidth = 1.5;
                if(cfg.rSty === 'dashed') tCtx.setLineDash([8, 8]); else tCtx.setLineDash([]);
                const count = parseInt(getVal('ringCount'));
                const speed = 80;
                const interval = parseInt(getVal('ringInterval'));

                for(let i = 1; i <= count; i++) {
                    const rPx = (i * interval * speed * scaleFactor) / 111320;
                    tCtx.beginPath(); tCtx.arc(baseW/2 + offsetX, baseH/2 + offsetY, rPx, 0, Math.PI*2); tCtx.stroke();
                    tCtx.setLineDash([]);
                    tCtx.font = `bold ${11 * zoom}px Arial`; tCtx.fillStyle = cfg.rCol;
                    tCtx.fillText(`${i*interval}min`, baseW/2 + offsetX + rPx + 5, baseH/2 + offsetY);
                    if(cfg.rSty === 'dashed') tCtx.setLineDash([8, 8]);
                }
                tCtx.setLineDash([]);
            }

            // 3. Vias
            const mainTypes = ["motorway", "trunk", "primary", "secondary", "tertiary"];
            lastData.forEach(way => {
                if (!way.geometry) return;
                const isMain = mainTypes.includes(way.tags.highway);
                tCtx.beginPath();
                tCtx.strokeStyle = isMain ? cfg.cMain : cfg.cMin;
                tCtx.lineWidth = isMain ? cfg.wMain : cfg.wMin;
                tCtx.lineCap = "round"; tCtx.lineJoin = "round";
                way.geometry.forEach((p, i) => {
                    const x = baseW/2 + offsetX + (p.lon - lastCoords.lon) * scaleFactor * Math.cos(lastCoords.lat * Math.PI/180);
                    const y = baseH/2 + offsetY - (p.lat - lastCoords.lat) * scaleFactor;
                    if (i === 0) tCtx.moveTo(x, y); else tCtx.lineTo(x, y);
                });
                tCtx.stroke();
            });

            // 4. Marcadores
            const drawP = (lat, lon, icon, col, tCol, label, size) => {
                const x = baseW/2 + offsetX + (lon - lastCoords.lon) * scaleFactor * Math.cos(lastCoords.lat * Math.PI/180);
                const y = baseH/2 + offsetY - (lat - lastCoords.lat) * scaleFactor;
                tCtx.textAlign = "center";
                tCtx.font = `${size * zoom}px Arial`; tCtx.fillStyle = col;
                tCtx.fillText(icon, x, y);
                if(label) {
                    tCtx.font = `bold ${13 * zoom}px Arial`; tCtx.fillStyle = tCol;
                    tCtx.fillText(label, x, y + (size * 0.8 * zoom));
                }
            };

            if (getCheck('showCenter')) {
                drawP(lastCoords.lat, lastCoords.lon, getVal('centerIcon'), getVal('centerColor'), getVal('centerTextColor'), getVal('centerLabel'), 45);
            }
            marcadoresExtras.forEach(m => drawP(m.lat, m.lon, 'üìç', '#0000ff', '#000', m.label, 35));

            // 5. Escala
            const sPx = (500 * scaleFactor) / 111320;
            tCtx.fillStyle = cfg.cMain; tCtx.fillRect(30, baseH - 30, sPx, 4);
            tCtx.font = `bold 13px Arial`; tCtx.fillText(`500m`, 30, baseH - 40);

            tCtx.restore();
        }

        function baixarSVG() {
            if (!lastData) return;
            const getVal = (id) => document.getElementById(id)?.value;
            const getCheck = (id) => document.getElementById(id)?.checked;
            const w = canvas.width, h = canvas.height;
            const scaleF = (h / (lastRaio * 2)) * 111320 * zoom;

            let s = `<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">`;
            s += `<rect width="100%" height="100%" fill="${getVal('bgColor')}"/>`;

            if (getCheck('showGrid')) {
                const step = 100 * zoom;
                for(let i = (w/2 + offsetX) % step; i < w; i += step) s += `<line x1="${i}" y1="0" x2="${i}" y2="${h}" stroke="${getVal('gridColor')}" stroke-width="1"/>`;
                for(let i = (h/2 + offsetY) % step; i < h; i += step) s += `<line x1="0" y1="${i}" x2="${w}" y2="${i}" stroke="${getVal('gridColor')}" stroke-width="1"/>`;
            }

            if (getCheck('showTimeRings')) {
                const dash = getVal('ringStyle') === 'dashed' ? 'stroke-dasharray="8,8"' : '';
                const count = parseInt(getVal('ringCount'));
                const interval = parseInt(getVal('ringInterval'));
                for(let i=1; i<=count; i++) {
                    const rPx = (i * interval * 80 * scaleF) / 111320;
                    s += `<circle cx="${w/2 + offsetX}" cy="${h/2 + offsetY}" r="${rPx}" fill="none" stroke="${getVal('ringColor')}" stroke-width="1.5" ${dash}/>`;
                    s += `<text x="${w/2 + offsetX + rPx + 5}" y="${h/2 + offsetY}" font-family="Arial" font-size="${11*zoom}" fill="${getVal('ringColor')}">${i*interval}min</text>`;
                }
            }

            const mainTypes = ["motorway", "trunk", "primary", "secondary", "tertiary"];
            lastData.forEach(way => {
                if(!way.geometry) return;
                const isMain = mainTypes.includes(way.tags.highway);
                let d = "";
                way.geometry.forEach((p, i) => {
                    const x = w/2 + offsetX + (p.lon - lastCoords.lon) * scaleF * Math.cos(lastCoords.lat * Math.PI/180);
                    const y = h/2 + offsetY - (p.lat - lastCoords.lat) * scaleF;
                    d += (i===0 ? "M" : "L") + x.toFixed(2) + "," + y.toFixed(2);
                });
                s += `<path d="${d}" fill="none" stroke="${isMain ? getVal('colorMain') : getVal('colorMinor')}" stroke-width="${isMain ? parseFloat(getVal('widthMain'))*zoom : parseFloat(getVal('widthMinor'))*zoom}" stroke-linecap="round"/>`;
            });

            if (getCheck('showCenter')) {
                const cx = w/2 + offsetX, cy = h/2 + offsetY;
                s += `<text x="${cx}" y="${cy}" font-family="Arial" font-size="${45*zoom}" text-anchor="middle" fill="${getVal('centerColor')}">${getVal('centerIcon')}</text>`;
                if(getVal('centerLabel')) s += `<text x="${cx}" y="${cy+35*zoom}" font-family="Arial" font-size="${13*zoom}" font-weight="bold" text-anchor="middle" fill="${getVal('centerTextColor')}">${getVal('centerLabel')}</text>`;
            }

            s += `</svg>`;
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([s], {type: 'image/svg+xml'}));
            a.download = "mapa_vetor.svg"; a.click();
        }

        async function baixarImagem(fmt) {
            const res = parseInt(document.getElementById('exportPx').value);
            const tempCanvas = document.createElement('canvas');
            const ratio = canvas.width / canvas.height;
            tempCanvas.width = res; tempCanvas.height = res / ratio;
            desenhar(tempCanvas.getContext('2d'), tempCanvas.width, tempCanvas.height, true);
            const a = document.createElement('a'); a.download = `mapa_hd.${fmt}`;
            a.href = tempCanvas.toDataURL(fmt === 'png' ? 'image/png' : 'image/jpeg', 0.98);
            a.click();
        }

        function baixarJSON() {
            const d = { metadata: { centro: lastCoords, raio: lastRaio }, vias: lastData };
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(d, null, 2)], {type: 'application/json'}));
            a.download = "mapa_data.json"; a.click();
        }

        canvas.addEventListener('mousedown', e => { isDragging = true; lastMousePos = {x: e.clientX, y: e.clientY}; });
        window.addEventListener('mousemove', e => {
            if (isDragging) {
                offsetX += e.clientX - lastMousePos.x; offsetY += e.clientY - lastMousePos.y;
                lastMousePos = {x: e.clientX, y: e.clientY}; desenhar();
            }
        });
        window.addEventListener('mouseup', () => isDragging = false);
        
        canvas.addEventListener('click', e => {
            if (!modoAdicionarMarcador) return;
            const rect = canvas.getBoundingClientRect();
            const scale = (canvas.height / (lastRaio * 2)) * 111320 * zoom;
            const lon = (e.clientX - rect.left - canvas.width/2 - offsetX) / (scale * Math.cos(lastCoords.lat * Math.PI/180)) + lastCoords.lon;
            const lat = lastCoords.lat - (e.clientY - rect.top - canvas.height/2 - offsetY) / scale;
            marcadoresExtras.push({ lat, lon, label: 'Ponto' });
            desenhar(); ativarModoMarcador();
        });

        function ativarModoMarcador() { modoAdicionarMarcador = !modoAdicionarMarcador; document.getElementById('btnAddMarker').style.background = modoAdicionarMarcador ? "red" : ""; }
        function limparMarcadores() { marcadoresExtras = []; desenhar(); }
        function ajustarProporcao() {
            const f = document.getElementById('exportFormat').value;
            const m = document.getElementById('main');
            if (f === 'free') { canvas.width = m.clientWidth - 40; canvas.height = m.clientHeight - 40; }
            else {
                const rs = { "1:1": 1, "a4-p": 1/1.41, "a4-l": 1.41 };
                canvas.height = m.clientHeight - 60; canvas.width = canvas.height * rs[f];
            }
            desenhar();
        }
        function atualizarEstat() { infoMap.innerHTML = `Vias: ${lastData?.length || 0}<br>Lat: ${lastCoords?.lat.toFixed(5)}<br>Lon: ${lastCoords?.lon.toFixed(5)}`; }
        window.addEventListener('resize', ajustarProporcao);
        ajustarProporcao();
    </script>
</body>
</html>
